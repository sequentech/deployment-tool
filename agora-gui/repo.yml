# This file is part of agora-dev-box.
# Copyright (C) 2014-2016  Agora Voting SL <agora@agoravoting.com>

# agora-dev-box is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License.

# agora-dev-box  is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public License
# along with agora-dev-box.  If not, see <http://www.gnu.org/licenses/>.

---
- name: AgoraGui, Git clone agora-gui-common
  become: true
  become_user: agoragui
  git:
    repo: "{{ repos.guicommon.repo }}"
    version: "{{ repos.guicommon.version }}"
    dest: /home/agoragui/agora-gui-common
    force: "{{ repos.guicommon.force }}"

- name: AgoraGui, Git clone agora-gui-admin
  become: true
  become_user: agoragui
  git:
    repo: "{{ repos.guiadmin.repo }}"
    version: "{{ repos.guiadmin.version }}"
    dest: /home/agoragui/agora-gui-admin
    force: "{{ repos.guiadmin.force }}"

- name: AgoraGui, Git clone agora-gui-elections
  become: true
  become_user: agoragui
  git:
    repo: "{{ repos.guielections.repo }}"
    version: "{{ repos.guielections.version }}"
    dest: /home/agoragui/agora-gui-elections
    force: "{{ repos.guielections.force }}"

- name: AgoraGui, Git clone agora-gui-booth
  become: true
  become_user: agoragui
  git:
    repo: "{{ repos.guibooth.repo }}"
    version: "{{ repos.guibooth.version }}"
    dest: /home/agoragui/agora-gui-booth
    force: "{{ repos.guibooth.force }}"

- name: AgoraGui, copying avConfig.js in user agora-gui-elections and agora-gui-booth
  become: true
  become_user: agoragui
  template:
    src: agora-gui/templates/avConfig.js
    dest: /home/agoragui/{{ item }}/avConfig.js
    owner: agoragui
    group: agoragui
    mode: '0600'
  with_items:
    - agora-gui-admin
    - agora-gui-elections
    - agora-gui-booth

- name: AgoraGui, setting admin timeout correctly in agora-gui-admin
  become: true
  become_user: agoragui
  replace:
    dest: /home/agoragui/agora-gui-admin/avConfig.js
    regexp: " timeoutSeconds:.*"
    replace: ' timeoutSeconds: {{config.authapi.admin_auth_token_expiration_seconds}},'

- name: AgoraGui, setting admin timeout correctly in agora-gui-admin, 2
  become: true
  become_user: agoragui
  replace:
    dest: /home/agoragui/agora-gui-admin/avConfig.js
    regexp:  "expires:.*"
    replace: ' expires: {{ (config.authapi.admin_auth_token_expiration_seconds / 60) | int }},'

- name: AgoraGui, modifying agora-gui-admin avConfig.js for securing the api calls
  become: true
  become_user: agoragui
  replace:
    dest: /home/agoragui/agora-gui-admin/avConfig.js
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
  with_items:
    - regexp: 'baseUrl:.*$'
      replace: 'baseUrl: "https://{{config.agora_elections.domain}}/admin-api/elections/api/",'
    - regexp: 'publicURL:.*$'
      replace: 'publicURL: "https://{{config.agora_elections.domain}}/admin-api/elections/public/",'
    - regexp: 'authAPI:.*$'
      replace: 'authAPI: "https://{{config.agora_elections.domain}}/admin-api/authapi/api/",'
    - regexp: 'dnieUrl:.*$'
      replace: 'dnieUrl: "https://{{config.agora_elections.domain}}/admin-api/authapi/api/authmethod/dnie/auth/",'
    - regexp: 'electionsAPI:.*$'
      replace: 'electionsAPI: "https://{{config.agora_elections.domain}}/admin-api/elections/api/",'

# this is not slow because yarn caches dependencies
- name: AgoraGui, removing node_modules directory to start fresh
  become: true
  become_user: agoragui
  file:
    path: "/home/agoragui/{{item}}/node_modules"
    state: absent
  with_items:
    - agora-gui-admin
    - agora-gui-elections
    - agora-gui-booth

- name: AgoraGui, configuring agora-gui-common version in agora-gui-*
  become: true
  become_user: agoragui
  replace:
    dest: /home/agoragui/{{item}}/package.json
    regexp: '"agora-gui-common"(.) "[^"]+(".*)$'
    replace: '"agora-gui-common"\1 "{{repos.guicommon.repo}}#{{repos.guicommon.version}}\2'
  with_items:
    - agora-gui-admin
    - agora-gui-elections
    - agora-gui-booth

- name: AgoraGui, make sure to upgrade agora-gui-common dependency repo
  become: true
  become_user: agoragui
  shell:
    chdir: "/home/agoragui/{{item}}/"
    cmd: yarn && yarn upgrade agora-gui-common
  with_items:
    - agora-gui-admin
    - agora-gui-elections
    - agora-gui-booth
